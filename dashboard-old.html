<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Session Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .controls h2 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .session-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .session-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .session-id {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-connected {
            background: #10b981;
            color: white;
        }

        .status-connecting {
            background: #f59e0b;
            color: white;
        }

        .status-disconnected {
            background: #ef4444;
            color: white;
        }

        .session-info {
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-weight: 600;
        }

        .qr-container {
            text-align: center;
            margin: 15px 0;
        }

        .qr-container img {
            max-width: 200px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .pairing-code {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            letter-spacing: 4px;
            margin: 15px 0;
        }

        .logs-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .log-time {
            color: #888;
            margin-right: 10px;
        }

        .session-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .session-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .no-sessions {
            text-align: center;
            padding: 60px 20px;
            color: white;
            font-size: 18px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connecting-indicator {
            animation: pulse 2s infinite;
        }

        /* Status Section Styling */
        .status-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .status-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .status-stats {
            margin-bottom: 12px;
        }

        .status-count {
            font-size: 13px;
            color: #666;
        }

        .status-actions {
            display: flex;
            gap: 8px;
        }

        .btn-status-post, .btn-status-view {
            flex: 1;
            padding: 8px 12px;
            font-size: 13px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-status-post {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-status-post:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-status-view {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-status-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        /* Tab Styling */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f9fafb;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f9fafb;
        }

        .tab-content {
            margin-bottom: 20px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Statuses List Styling */
        .statuses-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }

        .status-item:hover {
            background: #f9fafb;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-preview {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            margin-right: 15px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .status-preview.text {
            padding: 10px;
            word-break: break-word;
            text-align: center;
        }

        .status-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
        }

        .status-details {
            flex: 1;
        }

        .status-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .badge-text {
            background: #667eea;
            color: white;
        }

        .badge-image {
            background: #10b981;
            color: white;
        }

        .badge-video {
            background: #ef4444;
            color: white;
        }

        .status-meta {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .status-actions-inline {
            display: flex;
            gap: 8px;
        }

        .status-actions-inline button {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WhatsApp Session Dashboard</h1>

        <div class="controls">
            <h2>Create New Session</h2>
            <div class="form-group">
                <label for="sessionId">Session ID:</label>
                <input type="text" id="sessionId" placeholder="Enter a unique session ID">
            </div>
            <div class="form-group">
                <label for="authMethod">Authentication Method:</label>
                <select id="authMethod">
                    <option value="qr">QR Code</option>
                    <option value="pairing">Pairing Code</option>
                </select>
            </div>
            <div class="form-group" id="phoneNumberGroup" style="display: none;">
                <label for="phoneNumber">Phone Number (with country code):</label>
                <input type="tel" id="phoneNumber" placeholder="e.g., 1234567890">
            </div>
            <button onclick="createSession()">Create Session</button>
            <button onclick="loadSessions()" class="btn-secondary">Refresh Sessions</button>
        </div>

        <div id="sessionsContainer">
            <div class="loading">Loading sessions...</div>
        </div>
    </div>

    <div id="logsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="logsModalTitle">Session Logs</h2>
            </div>
            <div class="logs-container" id="modalLogs">
                <div class="log-entry">No logs available</div>
            </div>
            <div class="modal-footer">
                <button onclick="closeLogsModal()" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="postStatusModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Post WhatsApp Status</h2>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('text')">üìù Text</button>
                <button class="tab-btn" onclick="switchTab('image')">üñºÔ∏è Image</button>
                <button class="tab-btn" onclick="switchTab('video')">üé• Video</button>
            </div>
            <div class="tab-content">
                <!-- Text Status Tab -->
                <div id="tab-text" class="tab-panel active">
                    <div class="form-group">
                        <label for="statusText">Status Text:</label>
                        <textarea id="statusText" rows="4" placeholder="What's on your mind?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="bgColor">Background Color:</label>
                        <select id="bgColor">
                            <option value="#667eea">Purple</option>
                            <option value="#10b981">Green</option>
                            <option value="#3b82f6">Blue</option>
                            <option value="#ef4444">Red</option>
                            <option value="#f59e0b">Orange</option>
                            <option value="#8b5cf6">Violet</option>
                        </select>
                    </div>
                </div>
                <!-- Image Status Tab -->
                <div id="tab-image" class="tab-panel">
                    <div class="form-group">
                        <label for="imageUrl">Image URL:</label>
                        <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="form-group">
                        <label for="imageCaption">Caption (optional):</label>
                        <textarea id="imageCaption" rows="2" placeholder="Add a caption..."></textarea>
                    </div>
                </div>
                <!-- Video Status Tab -->
                <div id="tab-video" class="tab-panel">
                    <div class="form-group">
                        <label for="videoUrl">Video URL:</label>
                        <input type="text" id="videoUrl" placeholder="https://example.com/video.mp4">
                    </div>
                    <div class="form-group">
                        <label for="videoCaption">Caption (optional):</label>
                        <textarea id="videoCaption" rows="2" placeholder="Add a caption..."></textarea>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="sendToAllContacts" checked>
                    Send to all contacts
                </label>
            </div>
            <div class="modal-footer">
                <button onclick="closePostStatusModal()" class="btn-secondary">Cancel</button>
                <button onclick="postStatus()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Post Status</button>
            </div>
        </div>
    </div>

    <div id="viewStatusesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="viewStatusesTitle">My Statuses</h2>
            </div>
            <div id="statusesList" class="statuses-list">
                <div style="text-align: center; padding: 40px; color: #666;">Loading...</div>
            </div>
            <div class="modal-footer">
                <button onclick="closeViewStatusesModal()" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Status Details Modal -->
    <div id="statusDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Status Details</h2>
            </div>
            <div id="statusDetailsContent" style="max-height: 600px; overflow-y: auto;">
                <div style="text-align: center; padding: 40px; color: #666;">Loading...</div>
            </div>
            <div class="modal-footer">
                <button id="deleteStatusDetailsBtn" onclick="deleteStatusFromDetails()" class="btn-secondary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-right: auto;">Delete Status</button>
                <button onclick="closeStatusDetailsModal()" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let sessionsData = {};
        let logsData = {};

        // Show/hide phone number input based on auth method
        document.getElementById('authMethod').addEventListener('change', function() {
            const phoneGroup = document.getElementById('phoneNumberGroup');
            phoneGroup.style.display = this.value === 'pairing' ? 'block' : 'none';
        });

        async function createSession() {
            const sessionId = document.getElementById('sessionId').value.trim();
            const authMethod = document.getElementById('authMethod').value;
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (!sessionId) {
                alert('Please enter a session ID');
                return;
            }

            try {
                // Create session
                const response = await fetch(`${API_BASE}/session/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create session');
                }

                // If pairing code method, request the code
                if (authMethod === 'pairing' && phoneNumber) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait for session to initialize
                    const codeResponse = await fetch(`${API_BASE}/session/${sessionId}/request-code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phoneNumber })
                    });

                    if (!codeResponse.ok) {
                        throw new Error('Failed to request pairing code');
                    }
                }

                alert(`Session ${sessionId} created successfully!`);
                document.getElementById('sessionId').value = '';
                document.getElementById('phoneNumber').value = '';
                loadSessions();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/sessions`);
                if (!response.ok) throw new Error('Failed to load sessions');

                const data = await response.json();
                sessionsData = data.sessions || {};
                renderSessions();
            } catch (error) {
                document.getElementById('sessionsContainer').innerHTML =
                    `<div class="no-sessions">Error loading sessions: ${error.message}</div>`;
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            const sessionIds = Object.keys(sessionsData);

            if (sessionIds.length === 0) {
                container.innerHTML = '<div class="no-sessions">No sessions found. Create one to get started!</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'sessions-grid';

            sessionIds.forEach(sessionId => {
                const session = sessionsData[sessionId];
                const card = createSessionCard(sessionId, session);
                grid.appendChild(card);

                // Load status count for connected sessions
                if (session.status === 'connected') {
                    loadStatusCount(sessionId);
                }
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        async function loadStatusCount(sessionId) {
            try {
                // Validate sessionId before making request
                if (!sessionId || typeof sessionId !== 'string' || sessionId.length > 100) {
                    console.error('Invalid sessionId:', sessionId);
                    return;
                }

                // Properly encode the sessionId for URL
                const encodedSessionId = encodeURIComponent(sessionId);
                const response = await fetch(`${API_BASE}/stories?sessionId=${encodedSessionId}`);
                if (!response.ok) return;

                const data = await response.json();
                const stories = data.stories || [];

                const statsElement = document.getElementById(`status-stats-${sessionId}`);
                if (statsElement) {
                    const totalViews = stories.reduce((sum, story) => sum + (story.views?.total || 0), 0);
                    statsElement.innerHTML = `
                        <span class="status-count">üìä ${stories.length} active status${stories.length !== 1 ? 'es' : ''} ‚Ä¢ ${totalViews} total views</span>
                    `;
                }
            } catch (error) {
                console.error('Error loading status count:', error);
            }
        }

        function createSessionCard(sessionId, session) {
            const card = document.createElement('div');
            card.className = 'session-card';

            const statusClass = `status-${session.status}`;
            const statusText = session.status.charAt(0).toUpperCase() + session.status.slice(1);

            let qrSection = '';
            if (session.qr && session.status !== 'connected') {
                qrSection = `
                    <div class="qr-container">
                        <img src="${session.qr}" alt="QR Code" />
                        <p style="margin-top: 10px; color: #666;">Scan with WhatsApp</p>
                    </div>
                `;
            }

            let pairingSection = '';
            if (session.pairingCode && session.status !== 'connected') {
                pairingSection = `
                    <div class="pairing-code">${session.pairingCode}</div>
                    <p style="text-align: center; color: #666; margin-bottom: 10px;">Enter this code in WhatsApp</p>
                `;
            }

            card.innerHTML = `
                <div class="session-header">
                    <div class="session-id">${sessionId}</div>
                    <div class="status-badge ${statusClass} ${session.status === 'connecting' ? 'connecting-indicator' : ''}">
                        ${statusText}
                    </div>
                </div>
                <div class="session-info">
                    ${session.accountPhoneNumber ? `
                        <div class="info-item">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${session.accountPhoneNumber}</span>
                        </div>
                    ` : ''}
                    ${session.authMethod ? `
                        <div class="info-item">
                            <span class="info-label">Auth Method:</span>
                            <span class="info-value">${session.authMethod === 'qr' ? 'QR Code' : 'Pairing Code'}</span>
                        </div>
                    ` : ''}
                    <div class="info-item">
                        <span class="info-label">Last Updated:</span>
                        <span class="info-value">${new Date(session.lastUpdated).toLocaleString()}</span>
                    </div>
                </div>
                ${qrSection}
                ${pairingSection}
                ${session.status === 'connected' ? `
                <div class="status-section">
                    <h3 class="status-title">WhatsApp Status</h3>
                    <div class="status-stats" id="status-stats-${sessionId}">
                        <span class="status-count">Loading...</span>
                    </div>
                    <div class="status-actions">
                        <button onclick="openPostStatusModal('${sessionId}')" class="btn-status-post">
                            ‚ûï Post Status
                        </button>
                        <button onclick="viewStatuses('${sessionId}')" class="btn-status-view">
                            üìä View Statuses
                        </button>
                    </div>
                </div>
                ` : ''}
                <div class="session-actions">
                    <button onclick="viewLogs('${sessionId}')" class="btn-secondary">View Logs</button>
                    <button onclick="deleteSession('${sessionId}')" class="btn-danger">Delete</button>
                </div>
            `;

            return card;
        }

        async function deleteSession(sessionId) {
            if (!confirm(`Are you sure you want to delete session "${sessionId}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete session');

                alert(`Session ${sessionId} deleted successfully`);
                loadSessions();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function viewLogs(sessionId) {
            const modal = document.getElementById('logsModal');
            const logsContainer = document.getElementById('modalLogs');
            const modalTitle = document.getElementById('logsModalTitle');

            // Update modal title
            modalTitle.textContent = `Logs for ${sessionId}`;

            // Show loading state
            logsContainer.innerHTML = '<div class="log-entry">Loading logs...</div>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}/logs`);
                if (!response.ok) throw new Error('Failed to load logs');

                const data = await response.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    logsContainer.innerHTML = '<div class="log-entry">No logs available for this session</div>';
                } else {
                    logsContainer.innerHTML = logs.map(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        const levelColor = log.level === 'error' ? '#ef4444' :
                                          log.level === 'warn' ? '#f59e0b' : '#10b981';
                        return `
                            <div class="log-entry">
                                <span class="log-time">${time}</span>
                                <span style="color: ${levelColor}; font-weight: 600;">[${log.level.toUpperCase()}]</span>
                                <span>${log.message}</span>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                logsContainer.innerHTML = `<div class="log-entry" style="color: #ef4444;">Error loading logs: ${error.message}</div>`;
            }
        }

        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
        }

        // Status Management Functions
        let currentSessionId = null;
        let currentTab = 'text';

        function openPostStatusModal(sessionId) {
            currentSessionId = sessionId;
            document.getElementById('postStatusModal').style.display = 'block';

            // Reset form
            document.getElementById('statusText').value = '';
            document.getElementById('imageUrl').value = '';
            document.getElementById('imageCaption').value = '';
            document.getElementById('videoUrl').value = '';
            document.getElementById('videoCaption').value = '';
            document.getElementById('sendToAllContacts').checked = true;

            // Switch to text tab by default
            switchTab('text');
        }

        function closePostStatusModal() {
            document.getElementById('postStatusModal').style.display = 'none';
            currentSessionId = null;
        }

        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        async function postStatus() {
            if (!currentSessionId) {
                alert('Error: No session selected');
                return;
            }

            try {
                let payload = {
                    sessionId: currentSessionId,
                    type: currentTab,
                    send_to_all_contacts: document.getElementById('sendToAllContacts').checked
                };

                if (currentTab === 'text') {
                    const text = document.getElementById('statusText').value.trim();
                    if (!text) {
                        alert('Please enter status text');
                        return;
                    }
                    payload.content = text;
                    payload.backgroundColor = document.getElementById('bgColor').value;
                } else if (currentTab === 'image') {
                    const url = document.getElementById('imageUrl').value.trim();
                    if (!url) {
                        alert('Please enter image URL');
                        return;
                    }
                    payload.content = url;
                    payload.caption = document.getElementById('imageCaption').value.trim();
                } else if (currentTab === 'video') {
                    const url = document.getElementById('videoUrl').value.trim();
                    if (!url) {
                        alert('Please enter video URL');
                        return;
                    }
                    payload.content = url;
                    payload.caption = document.getElementById('videoCaption').value.trim();
                }

                const response = await fetch(`${API_BASE}/story/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to post status');
                }

                const result = await response.json();
                alert(`Status posted successfully!\nStory ID: ${result.storyId}`);
                closePostStatusModal();

                // Refresh status count
                loadStatusCount(currentSessionId);
            } catch (error) {
                alert(`Error posting status: ${error.message}`);
            }
        }

        async function viewStatuses(sessionId) {
            currentSessionId = sessionId;
            const modal = document.getElementById('viewStatusesModal');
            const listContainer = document.getElementById('statusesList');

            modal.style.display = 'block';
            listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading...</div>';

            try {
                const encodedSessionId = encodeURIComponent(sessionId);
                const response = await fetch(`${API_BASE}/stories?sessionId=${encodedSessionId}`);
                if (!response.ok) throw new Error('Failed to load statuses');

                const data = await response.json();
                const stories = data.stories || [];

                if (stories.length === 0) {
                    listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No statuses found. Post one to get started!</div>';
                    return;
                }

                listContainer.innerHTML = stories.map(story => {
                    const timeAgo = getTimeAgo(new Date(story.createdAt));
                    const views = story.views?.total || 0;
                    const likes = story.likes?.total || 0;
                    const reactions = story.reactions?.total || 0;

                    let preview = '';
                    if (story.type === 'text') {
                        const bgColor = story.backgroundColor || '#667eea';
                        const text = story.content.substring(0, 30) + (story.content.length > 30 ? '...' : '');
                        preview = `<div class="status-preview text" style="background: ${bgColor}">${text}</div>`;
                    } else if (story.type === 'image') {
                        preview = `<div class="status-preview"><img src="${story.content}" alt="Status" /></div>`;
                    } else if (story.type === 'video') {
                        preview = `<div class="status-preview" style="background: #ef4444">üé• VIDEO</div>`;
                    }

                    return `
                        <div class="status-item">
                            ${preview}
                            <div class="status-details">
                                <span class="status-type-badge badge-${story.type}">${story.type.toUpperCase()}</span>
                                ${story.caption ? `<div style="font-size: 14px; color: #333; margin-bottom: 5px;">${story.caption}</div>` : ''}
                                <div class="status-meta">
                                    üìÖ ${timeAgo} ‚Ä¢ üëÅÔ∏è ${views} views ‚Ä¢ üíö ${likes} likes ‚Ä¢ üòä ${reactions} reactions
                                </div>
                            </div>
                            <div class="status-actions-inline">
                                <button onclick="viewStatusDetails('${story.storyId}')" class="btn-secondary">Details</button>
                                <button onclick="deleteStatus('${story.storyId}')" class="btn-danger">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                listContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;">Error: ${error.message}</div>`;
            }
        }

        function closeViewStatusesModal() {
            document.getElementById('viewStatusesModal').style.display = 'none';
        }

        async function deleteStatus(storyId) {
            if (!confirm('Are you sure you want to delete this status?')) return;

            try {
                const response = await fetch(`${API_BASE}/story/${storyId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete status');

                alert('Status deleted successfully!');
                viewStatuses(currentSessionId); // Refresh the list
                loadStatusCount(currentSessionId); // Update count
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        let currentStatusDetailsId = null;

        async function viewStatusDetails(storyId) {
            currentStatusDetailsId = storyId;
            const modal = document.getElementById('statusDetailsModal');
            const content = document.getElementById('statusDetailsContent');
            modal.style.display = 'flex';

            try {
                // Fetch story details and views in parallel
                const [storyResponse, viewsResponse] = await Promise.all([
                    fetch(`${API_BASE}/story/${storyId}`),
                    fetch(`${API_BASE}/story/${storyId}/views`)
                ]);

                if (!storyResponse.ok || !viewsResponse.ok) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load status details</div>';
                    return;
                }

                const story = await storyResponse.json();
                const viewsData = await viewsResponse.json();

                // Build the details view
                let html = '<div style="padding: 20px;">';

                // Story Content Section
                html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">';

                if (story.type === 'text') {
                    html += `<div style="background: ${story.backgroundColor || '#1f2937'}; padding: 30px; border-radius: 8px; text-align: center;">`;
                    html += `<p style="color: white; font-size: 24px; font-family: ${story.font || 'sans-serif'}; margin: 0; word-wrap: break-word;">${escapeHtml(story.content)}</p>`;
                    html += '</div>';
                } else if (story.type === 'image') {
                    html += `<img src="${story.content}" style="max-width: 100%; border-radius: 8px; display: block; margin: 0 auto;" alt="Status image">`;
                    if (story.caption) {
                        html += `<p style="color: white; margin-top: 10px; text-align: center;">${escapeHtml(story.caption)}</p>`;
                    }
                } else if (story.type === 'video') {
                    html += `<video controls style="max-width: 100%; border-radius: 8px; display: block; margin: 0 auto;" src="${story.content}"></video>`;
                    if (story.caption) {
                        html += `<p style="color: white; margin-top: 10px; text-align: center;">${escapeHtml(story.caption)}</p>`;
                    }
                }

                html += `<div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 15px; text-align: center;">`;
                html += `<span style="background: rgba(0,0,0,0.2); padding: 6px 12px; border-radius: 6px; margin-right: 10px;">${story.type.toUpperCase()}</span>`;
                html += `<span>${new Date(story.createdAt).toLocaleString()}</span>`;
                html += '</div>';
                html += '</div>';

                // Stats Overview
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                html += `<div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 12px; text-align: center;">`;
                html += `<div style="font-size: 32px; font-weight: bold; color: white;">${viewsData.totalViews || 0}</div>`;
                html += `<div style="color: rgba(255,255,255,0.8); margin-top: 5px;">Total Views</div>`;
                html += '</div>';
                html += `<div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; text-align: center;">`;
                html += `<div style="font-size: 32px; font-weight: bold; color: white;">${viewsData.totalLikes || 0}</div>`;
                html += `<div style="color: rgba(255,255,255,0.8); margin-top: 5px;">Likes üíö</div>`;
                html += '</div>';
                html += `<div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; text-align: center;">`;
                html += `<div style="font-size: 32px; font-weight: bold; color: white;">${viewsData.totalReactions || 0}</div>`;
                html += `<div style="color: rgba(255,255,255,0.8); margin-top: 5px;">Reactions</div>`;
                html += '</div>';
                html += '</div>';

                // Viewers List
                if (viewsData.views && viewsData.views.length > 0) {
                    html += '<div style="background: #1f2937; padding: 20px; border-radius: 12px; margin-bottom: 20px;">';
                    html += '<h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">üëÄ Viewers</h3>';
                    html += '<div style="max-height: 300px; overflow-y: auto;">';
                    viewsData.views.forEach(view => {
                        const viewerName = view.viewer.split('@')[0];
                        const viewedTime = view.viewedAt ? new Date(view.viewedAt).toLocaleString() : 'Delivered';
                        const deliveredTime = view.deliveredAt ? new Date(view.deliveredAt).toLocaleString() : '';

                        html += '<div style="background: #374151; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">';
                        html += `<div style="color: white; font-weight: 500;">${escapeHtml(viewerName)}</div>`;
                        html += '<div style="text-align: right;">';
                        if (view.viewedAt) {
                            html += `<div style="color: #10b981; font-size: 14px;">‚úì Viewed</div>`;
                            html += `<div style="color: #9ca3af; font-size: 12px;">${viewedTime}</div>`;
                        } else if (view.deliveredAt) {
                            html += `<div style="color: #60a5fa; font-size: 14px;">‚úì Delivered</div>`;
                            html += `<div style="color: #9ca3af; font-size: 12px;">${deliveredTime}</div>`;
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div></div>';
                } else {
                    html += '<div style="background: #1f2937; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; color: #9ca3af;">No views yet</div>';
                }

                // Likes List
                if (viewsData.likes && viewsData.likes.length > 0) {
                    html += '<div style="background: #1f2937; padding: 20px; border-radius: 12px; margin-bottom: 20px;">';
                    html += '<h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">üíö Likes</h3>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    viewsData.likes.forEach(like => {
                        const likerName = like.liker.split('@')[0];
                        html += `<div style="background: #374151; padding: 8px 16px; border-radius: 20px; color: white; font-size: 14px;">${escapeHtml(likerName)}</div>`;
                    });
                    html += '</div></div>';
                }

                // Reactions List
                if (viewsData.reactions && viewsData.reactions.length > 0) {
                    html += '<div style="background: #1f2937; padding: 20px; border-radius: 12px; margin-bottom: 20px;">';
                    html += '<h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">üòä Reactions</h3>';
                    html += '<div>';
                    viewsData.reactions.forEach(reaction => {
                        const reactorName = reaction.reactor.split('@')[0];
                        html += '<div style="background: #374151; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">';
                        html += `<div style="color: white; font-weight: 500;">${escapeHtml(reactorName)}</div>`;
                        html += `<div style="font-size: 24px;">${reaction.emoji}</div>`;
                        html += '</div>';
                    });
                    html += '</div></div>';
                }

                // Replies List
                if (viewsData.replies && viewsData.replies.length > 0) {
                    html += '<div style="background: #1f2937; padding: 20px; border-radius: 12px;">';
                    html += '<h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">üí¨ Replies</h3>';
                    html += '<div>';
                    viewsData.replies.forEach(reply => {
                        const replierName = reply.replier.split('@')[0];
                        const replyTime = new Date(reply.timestamp).toLocaleString();
                        html += '<div style="background: #374151; padding: 12px; border-radius: 8px; margin-bottom: 8px;">';
                        html += `<div style="color: white; font-weight: 500; margin-bottom: 5px;">${escapeHtml(replierName)}</div>`;
                        html += `<div style="color: #e5e7eb; margin-bottom: 5px;">${escapeHtml(reply.message)}</div>`;
                        html += `<div style="color: #9ca3af; font-size: 12px;">${replyTime}</div>`;
                        html += '</div>';
                    });
                    html += '</div></div>';
                }

                html += '</div>';

                content.innerHTML = html;

            } catch (error) {
                console.error('Error loading status details:', error);
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading status details</div>';
            }
        }

        function closeStatusDetailsModal() {
            document.getElementById('statusDetailsModal').style.display = 'none';
            currentStatusDetailsId = null;
        }

        async function deleteStatusFromDetails() {
            if (!currentStatusDetailsId) return;

            if (!confirm('Are you sure you want to delete this status? This will remove it from WhatsApp.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/story/${currentStatusDetailsId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeStatusDetailsModal();
                    // Refresh the status list if it's open
                    const viewStatusesModal = document.getElementById('viewStatusesModal');
                    if (viewStatusesModal.style.display === 'flex') {
                        // Find which session this was for and reload
                        const sessions = Object.keys(sessionsData);
                        for (const sessionId of sessions) {
                            loadStatusCount(sessionId);
                        }
                        // Close the view statuses modal since we deleted from details
                        closeViewStatusesModal();
                    }
                    alert('Status deleted successfully');
                } else {
                    alert('Failed to delete status');
                }
            } catch (error) {
                console.error('Error deleting status:', error);
                alert('Error deleting status');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const logsModal = document.getElementById('logsModal');
            const postModal = document.getElementById('postStatusModal');
            const viewModal = document.getElementById('viewStatusesModal');

            if (event.target === logsModal) {
                logsModal.style.display = 'none';
            }
            if (event.target === postModal) {
                closePostStatusModal();
            }
            if (event.target === viewModal) {
                closeViewStatusesModal();
            }
        }

        // Auto-refresh sessions every 5 seconds
        setInterval(loadSessions, 5000);

        // Clear any old cached session data on load
        try {
            localStorage.clear();
            sessionStorage.clear();
            console.log('Cleared browser cache to remove invalid session data');
        } catch (e) {
            console.error('Failed to clear cache:', e);
        }

        // Initial load - also clear any cached invalid data
        window.addEventListener('error', (event) => {
            // Catch and suppress the 404 errors from invalid session requests
            if (event.message && event.message.includes('404')) {
                event.preventDefault();
                console.warn('Suppressed 404 error from invalid cached session data');
            }
        });

        loadSessions();
    </script>
</body>
</html>
